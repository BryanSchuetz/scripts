module Cartograph
  module Installer
    @gem_file = File.join($data_dir, "cartograph.gemfile")
    @gem_file_contents = <<-GEMFILE
      source 'https://rubygems.org'
      gem 'eol-cartograph'
    GEMFILE

    def self.write_gem_file()
      return if Script.exists?(@gem_file)
      File.write(@gem_file, @gem_file_contents)
    end

    def self.setup()
      write_gem_file
      bundler_output = `bundle install --gemfile=#{@gem_file}`
      respond(bundler_output) if Script.current.vars.include?("--debug")
    end
  end
end

Map.respond_to?(:load_json) or fail <<~ERROR
  your lich version is too old
  it must implement Map.load_json/1
ERROR

# create the Gemfile
Cartograph::Installer.setup()
# refresh paths so we can require the MapDB
Gem.clear_paths
# load the Cartograph gem for usage
require 'eol-cartograph'
# print some info to the end user
# todo: this should be wrapped in some sort of Thread-safe Mutex
Map.clear
Map.load_json(Cartograph.map_file)
respond("[cartograph.mapdb] loaded v%s" % Cartograph::VERSION)